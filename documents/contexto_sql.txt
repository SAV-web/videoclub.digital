-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.actors (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  name text NOT NULL UNIQUE,
  name_norm text DEFAULT unaccent_immutable(lower(name)),
  CONSTRAINT actors_pkey PRIMARY KEY (id)
);
CREATE TABLE public.countries (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  name text NOT NULL UNIQUE,
  code text NOT NULL UNIQUE,
  name_norm text DEFAULT unaccent_immutable(lower(name)),
  CONSTRAINT countries_pkey PRIMARY KEY (id)
);
CREATE TABLE public.directors (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  name text NOT NULL UNIQUE,
  name_norm text DEFAULT unaccent_immutable(lower(name)),
  CONSTRAINT directors_pkey PRIMARY KEY (id)
);
CREATE TABLE public.genres (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  name text NOT NULL UNIQUE,
  name_norm text DEFAULT unaccent_immutable(lower(name)),
  CONSTRAINT genres_pkey PRIMARY KEY (id)
);
CREATE TABLE public.movie_actors (
  movie_id bigint NOT NULL,
  actor_id bigint NOT NULL,
  ordinality smallint,
  CONSTRAINT movie_actors_pkey PRIMARY KEY (movie_id, actor_id),
  CONSTRAINT movie_actors_movie_id_fkey FOREIGN KEY (movie_id) REFERENCES public.movies(id),
  CONSTRAINT movie_actors_actor_id_fkey FOREIGN KEY (actor_id) REFERENCES public.actors(id)
);
CREATE TABLE public.movie_directors (
  movie_id bigint NOT NULL,
  director_id bigint NOT NULL,
  CONSTRAINT movie_directors_pkey PRIMARY KEY (movie_id, director_id),
  CONSTRAINT movie_directors_movie_id_fkey FOREIGN KEY (movie_id) REFERENCES public.movies(id),
  CONSTRAINT movie_directors_director_id_fkey FOREIGN KEY (director_id) REFERENCES public.directors(id)
);
CREATE TABLE public.movie_genres (
  movie_id bigint NOT NULL,
  genre_id bigint NOT NULL,
  CONSTRAINT movie_genres_pkey PRIMARY KEY (movie_id, genre_id),
  CONSTRAINT movie_genres_movie_id_fkey FOREIGN KEY (movie_id) REFERENCES public.movies(id),
  CONSTRAINT movie_genres_genre_id_fkey FOREIGN KEY (genre_id) REFERENCES public.genres(id)
);
CREATE TABLE public.movie_selections (
  movie_id bigint NOT NULL,
  selection_id bigint NOT NULL,
  CONSTRAINT movie_selections_pkey PRIMARY KEY (movie_id, selection_id),
  CONSTRAINT movie_collections_movie_id_fkey FOREIGN KEY (movie_id) REFERENCES public.movies(id),
  CONSTRAINT movie_collections_collection_id_fkey FOREIGN KEY (selection_id) REFERENCES public.selections(id)
);
CREATE TABLE public.movie_studios (
  movie_id bigint NOT NULL,
  studio_id bigint NOT NULL,
  CONSTRAINT movie_studios_pkey PRIMARY KEY (movie_id, studio_id),
  CONSTRAINT movie_studios_movie_id_fkey FOREIGN KEY (movie_id) REFERENCES public.movies(id),
  CONSTRAINT movie_studios_studio_id_fkey FOREIGN KEY (studio_id) REFERENCES public.studios(id)
);
CREATE TABLE public.movies (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  title text NOT NULL,
  year integer,
  year_end text,
  type text,
  fa_rating real,
  fa_votes integer,
  imdb_rating real,
  imdb_votes integer,
  original_title text,
  minutes integer,
  synopsis text,
  fa_id text,
  imdb_id text,
  image text NOT NULL,
  thumbhash_st text,
  country_id bigint,
  last_synced_at timestamp with time zone,
  critic text,
  episodes integer,
  wikipedia text,
  genres_list text,
  directors_list text,
  actors_list text,
  title_norm text DEFAULT unaccent_immutable(lower(title)),
  relevance integer,
  selections_list text,
  studios_list text,
  justwatch text,
  genres_tsv tsvector DEFAULT to_tsvector('spanish'::regconfig, unaccent_immutable(genres_list)),
  directors_tsv tsvector DEFAULT to_tsvector('simple'::regconfig, unaccent_immutable(directors_list)),
  actors_tsv tsvector DEFAULT to_tsvector('simple'::regconfig, unaccent_immutable(actors_list)),
  selections_tsv tsvector DEFAULT to_tsvector('simple'::regconfig, unaccent_immutable(selections_list)),
  studios_tsv tsvector DEFAULT to_tsvector('simple'::regconfig, unaccent_immutable(studios_list)),
  avg_rating real DEFAULT 
CASE
    WHEN ((fa_rating IS NOT NULL) AND (fa_rating > (0)::double precision) AND ((imdb_rating IS NOT NULL) AND (imdb_rating > (0)::double precision))) THEN (((fa_rating + (0.3)::double precision) + (imdb_rating - (0.3)::double precision)) / (2.0)::double precision)
    WHEN ((fa_rating IS NOT NULL) AND (fa_rating > (0)::double precision)) THEN (fa_rating + (0.3)::double precision)
    WHEN ((imdb_rating IS NOT NULL) AND (imdb_rating > (0)::double precision)) THEN (imdb_rating - (0.3)::double precision)
    ELSE NULL::double precision
END,
  CONSTRAINT movies_pkey PRIMARY KEY (id),
  CONSTRAINT movies_country_id_fkey FOREIGN KEY (country_id) REFERENCES public.countries(id)
);
CREATE TABLE public.movies_staging (
  title text,
  year text,
  year_end text,
  type text,
  fa_rating text,
  fa_votes text,
  imdb_rating text,
  imdb_votes text,
  original_title text,
  country text,
  minutes text,
  directors text,
  actors text,
  genre text,
  synopsis text,
  fa_id text,
  imdb_id text,
  image text NOT NULL,
  collection text,
  critic text,
  episodes integer,
  wikipedia text,
  relevance integer,
  studio text,
  justwatch text,
  CONSTRAINT movies_staging_pkey PRIMARY KEY (image)
);
CREATE TABLE public.selections (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  name text NOT NULL UNIQUE,
  code character NOT NULL UNIQUE,
  CONSTRAINT selections_pkey PRIMARY KEY (id)
);
CREATE TABLE public.studios (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  name text NOT NULL UNIQUE,
  code text,
  CONSTRAINT studios_pkey PRIMARY KEY (id)
);
CREATE TABLE public.user_movie_entries (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  user_id uuid NOT NULL,
  movie_id bigint NOT NULL,
  on_watchlist boolean DEFAULT false,
  rating smallint CHECK (rating >= 1 AND rating <= 10),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_movie_entries_pkey PRIMARY KEY (id),
  CONSTRAINT user_movie_entries_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT user_movie_entries_movie_id_fkey FOREIGN KEY (movie_id) REFERENCES public.movies(id)
);
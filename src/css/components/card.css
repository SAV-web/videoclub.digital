/* =================================================================
 *          COMPONENTE: TARJETA DE PELÍCULA (Master)
 * ================================================================= */

/* =================================================================
   1. ANIMACIONES Y ESTRUCTURA BASE
   ================================================================= */

@keyframes card-appear {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes watchlist-pop {
  0% { transform: scale(1); }
  50% { transform: scale(1.3) rotate(-5deg); }
  100% { transform: scale(1); }
}

@keyframes watchlist-glow {
  0%, 100% { filter: drop-shadow(0 0 0 rgba(255, 189, 7, 0)); }
  50% { filter: drop-shadow(0 0 10px rgba(255, 189, 7, 0.8)); }
}

@keyframes fade-in-subtle {
  from { opacity: 0; transform: translateY(-5px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Contenedor principal */
.movie-card {
  position: relative;
  perspective: 1000px; /* Profundidad 3D */
  aspect-ratio: 500 / 950;
  border-radius: 10px;
  
  /* Renderizado optimizado: Omitir renderizado fuera de pantalla */
  content-visibility: auto;
  contain-intrinsic-size: 165px 314px;
  /* Aislamiento para evitar repintados en el resto de la página */
  contain: layout paint style; 

  /* Animación de entrada escalonada */
  animation: card-appear var(--duration-quick) var(--ease-smooth-out) backwards;
  animation-delay: calc(var(--card-index, 0) * 40ms);
  
  transition: transform var(--duration-quick) var(--ease-spring);
  
  /* UX TÁCTIL: Permite pan/zoom, deshabilita "doble tap para zoom" y delay */
  touch-action: manipulation;

  /* Interacciones Desktop */
  @media (hover: hover) and (pointer: fine) {
    &:not(.is-flipped):hover {
      transform: translateY(-8px) translateZ(0) scale(1.02);

      & .flip-card-inner {
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12);
      }

      html.dark-mode & .flip-card-inner {
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
      }
    }
  }
}

/* El "papel" que gira (Contenedor de caras) */
.flip-card-inner {
  position: relative;
  width: 100%;
  height: 100%;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
  background-color: var(--color-surface);
  border: 1px solid var(--color-surface);
  
  transform-style: preserve-3d; /* Habilita el 3D real */
  transition: transform var(--duration-leisurely) var(--ease-smooth-out), box-shadow var(--duration-quick) var(--ease-smooth-out);

  &.is-flipped { transform: rotateY(180deg); }

  html.dark-mode &.is-flipped {
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6), 0 10px 25px rgba(0, 0, 0, 0.4);
  }
}

/* =================================================================
   2. CARAS DE LA TARJETA (Frontal y Trasera)
   ================================================================= */

.flip-card-front, .flip-card-back {
  position: absolute;
  inset: 0; /* Reemplaza top/left/width/height */
  border-radius: var(--radius-lg);
  overflow: hidden;
  
  /* Oculta la cara opuesta */
  -webkit-backface-visibility: hidden;
  backface-visibility: hidden;
  
  background-color: var(--color-surface);
  color: var(--color-text-primary);
  display: flex;
  flex-direction: column;
}

/* --- Cara Frontal --- */
.flip-card-front {
  z-index: 2;
  pointer-events: auto; /* Interactuable por defecto */
}

/* --- Cara Trasera --- */
.flip-card-back {
  transform: rotateY(180deg); /* Pre-girada */
  padding: var(--space-xs) var(--space-sm);
  line-height: var(--line-height-normal);
  z-index: 1;
  pointer-events: none;

  /* Gestión de Interactividad al girar */
  .flip-card-inner.is-flipped & { pointer-events: auto; z-index: 2; }
}
.flip-card-inner.is-flipped .flip-card-front { pointer-events: none; z-index: 1; }

/* --- Imagen del Póster --- */
.poster-container {
  position: relative;
  width: 100%;
  height: 66%;
  flex-shrink: 0;

  & img {
    width: 100%;
    height: 100%;
    border: var(--space-xxs) solid var(--color-surface);
    border-radius: var(--radius-xl);
    object-fit: cover;
  }
}

/* Efecto carga LQIP (Blur) */
.flip-card-front img.lazy-lqip {
  filter: blur(10px);
  transform: scale(1.1);
  transition: filter var(--duration-normal) ease-in-out, transform var(--duration-normal) ease-in-out;
  &.loaded { filter: blur(0); transform: scale(1); }
}

/* =================================================================
   3. CONTENIDO FRONTAL (Resumen)
   ================================================================= */

.movie-summary {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  padding: calc(var(--space-md) + 3px) var(--space-sm) var(--space-xs);
  overflow: hidden;
}

.title-director-block {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

& h3 {
    margin-bottom: 0;
    line-height: 1.1;
    font-family: var(--font-title);
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-bold);
    letter-spacing: -0.025em;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
    overflow: hidden; text-overflow: ellipsis;
  }

.front-director-info {
  font-size: var(--font-size-xs);
  font-weight: var(--font-weight-light);
  color: var(--color-text-tertiary);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  & a { color: inherit; text-decoration: none; transition: color var(--duration-fast); }
}

/* Metadatos Frontales */
.movie-meta {
  padding-top: var(--space-xxs);
  display: flex; justify-content: space-between; align-items: center;
  min-height: 24px;
  font-size: var(--font-size-sm);
}

.card-icons-line { display: flex; align-items: center; gap: var(--space-xs); }
.platform-icon svg { vertical-align: middle; }
.year-flag-group { display: flex; align-items: center; gap: var(--space-sm); font-weight: var(--font-weight-semibold); color: var(--color-text-secondary); }
.country-info { display: flex; align-items: center; gap: var(--space-xxs); }

/* Colores de Estudios (Mantenidos igual) */
.netflix-icon { color: #e50914; }
.disney-icon { color: #990000; } html.dark-mode .disney-icon { color: #D9534F; }
.wb-icon { color: #000b6c; } html.dark-mode .wb-icon { color: #4da4f2; }
.universal-icon { color: #444444; } html.dark-mode .universal-icon { color: #BBBBBB; }
.sony-icon { color: #004098; } html.dark-mode .sony-icon { color: #3182ce; }
.paramount-icon { color: #0063ff; } html.dark-mode .paramount-icon { color: #E0E0E0; }
.lionsgate-icon { color: #CC7722; } html.dark-mode .lionsgate-icon { color: #f9d7b5; }
.amazon-icon { color: #f6a61f; }
.twenty-icon { color: #000b6c; } html.dark-mode .twenty-icon { color: #E0E0E0; }
.a24-icon { color: #000; } html.dark-mode .a24-icon { color: #fff; }
.movistar-icon { color: #00a9e0; }
.miramax-icon { color: #005596; } html.dark-mode .miramax-icon { color: #4da4f2; }

/* =================================================================
   4. CONTENIDO TRASERO (Detalles)
   ================================================================= */

.back-original-title-wrapper {
  display: flex; justify-content: flex-start; align-items: center;
  margin-bottom: 10px; padding-inline: var(--space-xs);
  min-height: calc(var(--font-size-sm) * var(--line-height-tight) * 2);
  width: 100%;
  animation: fade-in-subtle 0.5s var(--ease-smooth-out) 0.2s backwards;

  & span {
    font-family: var(--font-title); font-size: var(--font-size-sm); font-weight: var(--font-weight-bold);
    color: var(--color-text-primary); line-height: var(--line-height-tight);
    letter-spacing: -0.01em;
    text-align: left;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
    overflow: hidden; text-overflow: ellipsis;
  }
}

.back-meta-header {
  display: flex; justify-content: flex-end; align-items: center;
  width: 100%; margin-bottom: 10px;
  font-size: var(--font-size-sm);
}

.episode-duration-group {
  display: flex; align-items: center; gap: 4px;
  font-weight: var(--font-weight-medium); color: var(--color-text-secondary);
  white-space: nowrap;
}

[data-template="wikipedia-link"],
[data-template="justwatch-link"] {
  display: flex; align-items: center; text-decoration: none;
  transition: transform var(--duration-fast);
  margin-left: var(--space-xs);
  pointer-events: auto; 

  @media (hover: hover) and (pointer: fine) {
    &:hover { transform: scale(1.1); }
  }

  &.disabled {
    opacity: 0.3; pointer-events: none; filter: grayscale(100%); cursor: default;
  }
}

/* Listas de Detalles */
.details-list {
  display: flex; flex-direction: column; gap: var(--space-xxs);
  margin: var(--space-sm) 0 var(--space-xs); padding-top: var(--space-xs);
  border-top: 1px solid var(--color-border);
  font-size: var(--font-size-xs); line-height: var(--line-height-normal); color: var(--color-text-secondary);
}
.detail-item[data-template="actors-container"] {
  position: relative; overflow: hidden; text-overflow: ellipsis;
  display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical;
  padding-right: 10px;
}

/* Áreas con Scroll */
.scrollable-content {
  position: relative; overflow: hidden;
  transition: opacity var(--duration-normal) var(--ease-smooth-out), transform var(--duration-normal) var(--ease-smooth-out);

  &::after {
    content: ""; position: absolute; bottom: 0; left: 0; right: 0; height: 40px;
    background: linear-gradient(to bottom, transparent, var(--color-surface));
    pointer-events: none;
  }
  .flip-card-back.is-expanded &::after { opacity: 0; }
}

.plot-summary-final, .critic-review {
  padding-top: var(--space-xs); border-top: 1px solid var(--color-border);
  opacity: 0.8; font-size: var(--font-size-xs); color: var(--color-text-secondary);
  font-weight: var(--font-weight-normal); line-height: var(--line-height-relaxed);
}
.critic-review { margin-top: var(--space-sm); }

/* Overlay de Actores */
.actors-scrollable-content {
  position: absolute; inset: 0; padding: var(--space-md); padding-top: var(--space-xl);
  background-color: var(--color-surface);
  -webkit-overflow-scrolling: touch;
  overflow-y: auto; scrollbar-width: none;
  opacity: 0; visibility: hidden; transform: translateY(100%);
  transition: opacity var(--duration-normal) var(--ease-smooth-out), visibility var(--duration-normal) var(--ease-smooth-out), transform var(--duration-normal) var(--ease-smooth-out);
  z-index: 5;
  font-size: var(--font-size-sm); line-height: 1.6; color: var(--color-text-primary);
  pointer-events: auto;

  & h4 {
    margin-top: 0; margin-bottom: var(--space-sm);
    font-family: var(--font-title); font-size: var(--font-size-base); font-weight: var(--font-weight-bold);
    border-bottom: 1px solid var(--color-border); padding-bottom: var(--space-xxs);
    color: var(--color-text-primary);
  }
}
.actors-list-text { margin: 0; text-align: left; color: var(--color-text-primary); padding-bottom: var(--space-xl); }
.actor-list-item {
  background: none; border: none; padding: 0;
  font-family: inherit; font-size: inherit; color: var(--color-text-primary);
  text-align: left; cursor: pointer; display: block; width: 100%; line-height: 1.6;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  transition: color var(--transition-duration-fast);
  &:hover { color: var(--color-accent); text-decoration: underline; }
}

/* =================================================================
   5. BOTONES DE EXPANSIÓN Y LOGICA
   ================================================================= */

.expand-content-btn, .actors-expand-btn {
  position: absolute;
  width: 22px; height: 22px;
  border-radius: 50%; border: none;
  background-color: var(--color-accent); color: var(--color-surface);
  font-size: 1.25rem; font-weight: 400; line-height: 1;
  display: flex; align-items: center; justify-content: center;
  padding-bottom: 2px;
  cursor: pointer; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.25);
  transition: transform var(--duration-quick) ease-out, background-color var(--duration-quick) ease-out;
  z-index: var(--z-index-card-content);
  pointer-events: auto;

  @media (hover: hover) and (pointer: fine) {
    &:hover {
      transform: scale(1.15); background-color: var(--color-text-primary);
    }
  }
  &:active { transform: scale(0.9); }
}
.actors-expand-btn { bottom: 2px; right: 2px; }
.expand-content-btn { bottom: 14px; right: 14px; }

/* Lógica de Visibilidad al Expandir */
.flip-card-back.is-expanded > *:not(.scrollable-content):not(.expand-content-btn):not(.actors-scrollable-content) {
  opacity: 0; transform: translateY(-100%);
  transition: opacity var(--duration-quick), transform var(--duration-normal) var(--ease-smooth-out);
  pointer-events: none;
}

.flip-card-back.is-expanded .scrollable-content {
  position: absolute; inset: 0; padding: var(--space-md);
  background-color: var(--color-surface);
  overflow-y: auto; scrollbar-width: none;
  -webkit-overflow-scrolling: touch;
  pointer-events: auto; z-index: 15;
}

.flip-card-back.is-expanded.show-actors .actors-scrollable-content {
  opacity: 1; visibility: visible; transform: translateY(0);
}
.flip-card-back.is-expanded.show-actors .scrollable-content {
  opacity: 0 !important; visibility: hidden !important;
}

/* =================================================================
   6. ELEMENTOS INTERACTIVOS (Botones y Estrellas)
   ================================================================= */

.card-rating-block {
  position: absolute; bottom: 1px; left: 0; right: 0;
  transform: translateY(66.66%); z-index: 5;
  display: flex; justify-content: space-between; align-items: center;
  padding-inline: var(--space-sm);
  pointer-events: none;

  /* Efecto Aura */
  & > * {
    pointer-events: auto;
    filter: drop-shadow(0 0 6px var(--color-surface)) drop-shadow(0 0 8px var(--color-surface));
    transition: filter 0.3s ease, transform var(--duration-quick) var(--ease-spring);

    html.dark-mode & {
      filter: drop-shadow(0 0 1px #000) drop-shadow(0 0 2px #000) drop-shadow(0 0 4px #000);
    }
  }
}

.card-action-btn {
  width: 38px; height: 38px; padding: 0; border: none; border-radius: var(--radius-round);
  background-color: transparent; color: var(--color-accent); cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: transform var(--duration-normal) var(--ease-smooth-out), background-color var(--duration-normal) var(--ease-smooth-out), color var(--duration-normal) var(--ease-smooth-out);
  position: relative;

  @media (hover: hover) and (pointer: fine) {
    &:hover { transform: scale(1.15) rotate(10deg); }
  }
  &:active { transform: scale(0.9); }

  & svg {
    width: 30px; height: 30px;
    fill: transparent; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
    transition: fill var(--duration-normal) var(--ease-smooth-out), stroke var(--duration-normal) var(--ease-smooth-out), color var(--duration-normal) var(--ease-smooth-out), transform var(--duration-normal) var(--ease-smooth-out);
  }

  &.is-active {
    animation: watchlist-pop var(--duration-normal) var(--ease-bounce-in);
    & svg {
      color: #e50914; fill: #e50914; stroke: #e50914;
      --icon-plus-color: var(--color-surface);
      animation: watchlist-glow 0.6s ease-out;
    }
  }
}

/* =================================================================
   7. UTILIDADES
   ================================================================= */

[data-template="wikipedia-link"] .rating-icon,
[data-template="justwatch-link"] .rating-icon {
  width: 1.5em; height: 1.5em; transform: translateY(-1px);
}

/* =================================================================
   8. ACCESIBILIDAD TÁCTIL (WCAG 2.5.5)
   ================================================================= */

@media (hover: none) and (pointer: coarse) {
  /* Feedback táctil nativo */
  .movie-card:active { transform: scale(0.98); transition-duration: 0s; }

  /* Expandir áreas táctiles */
  .card-action-btn::after,
  .expand-content-btn::after,
  .actors-expand-btn::after {
    content: ''; position: absolute;
    top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: var(--tap-target-size); height: var(--tap-target-size); z-index: 10;
  }
}

/* =================================================================
   9. INTERACCIONES ESCRITORIO (Solo Mouse)
   ================================================================= */

@media (hover: hover) and (pointer: fine) {
  body:not(.rotation-disabled) .movie-card.is-hovered .flip-card-inner {
    transform: rotateY(180deg);
  }

  body.rotation-disabled .front-director-info a:hover { 
    color: var(--color-text-primary); text-decoration: underline; 
  }
}

/* =================================================================
   10. MODO MURO DE EXPLORACIÓN (Rotation Disabled)
   ================================================================= */

/* Ajuste de tarjeta visual */
body.rotation-disabled .movie-card:not(.is-quick-view) {
  aspect-ratio: 2 / 3.2;
  transition: transform var(--duration-quick) ease;
}

/* Ocultar textos */
body.rotation-disabled .movie-card:not(.is-quick-view) .movie-summary { display: none; }

/* Póster domina */
body.rotation-disabled .movie-card:not(.is-quick-view) .poster-container {
  height: 100%; display: flex; flex-direction: column;
}
body.rotation-disabled .movie-card:not(.is-quick-view) .poster-container img {
  height: 88%; object-fit: cover; border-radius: var(--radius-xl);
}

/* Bloque valoración inferior */
body.rotation-disabled .movie-card:not(.is-quick-view) .card-rating-block {
  position: static; transform: none; bottom: auto; left: auto; right: auto;
  height: 12%; justify-content: flex-start;
  padding: 2px 0 0 var(--space-sm); background: transparent;
}

/* Reducción elementos */
body.rotation-disabled .movie-card:not(.is-quick-view) .star-rating-container,
body.rotation-disabled .movie-card:not(.is-quick-view) .low-rating-circle {
  transform: scale(0.7); transform-origin: left center;
}

/* Watchlist flotante */
body.rotation-disabled .movie-card:not(.is-quick-view) .card-action-btn {
  position: absolute; top: 4px; right: 4px; z-index: 10;
  display: none; transform: scale(0.7);
  background-color: rgba(0, 0, 0, 0.6); border-radius: 50%;
}
body.rotation-disabled .movie-card:not(.is-quick-view) .card-action-btn.is-active { display: flex; }

/* En móvil desactivar interacción en elementos pequeños del muro */
@media (hover: none) and (pointer: coarse) {
  body.rotation-disabled .movie-card:not(.is-quick-view) .card-rating-block,
  body.rotation-disabled .movie-card:not(.is-quick-view) .card-action-btn {
    pointer-events: none;
  }
}